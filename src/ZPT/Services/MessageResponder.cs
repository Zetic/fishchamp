using Microsoft.Extensions.Logging;
using Remora.Discord.API.Abstractions.Gateway.Events;
using Remora.Discord.API.Abstractions.Objects;
using Remora.Discord.API.Abstractions.Rest;
using Remora.Discord.API.Objects;
using Remora.Discord.Gateway.Responders;
using Remora.Results;
using System.Drawing;
using ZPT.Models;

namespace ZPT.Services;

public class MessageResponder : IResponder<IMessageCreate>
{
    private readonly ILogger<MessageResponder> _logger;
    private readonly IDiscordRestChannelAPI _channelAPI;
    private readonly UserManagerService _userManager;
    private readonly GameDataService _gameData;
    private readonly GameLogicService _gameLogic;

    public MessageResponder(
        ILogger<MessageResponder> logger,
        IDiscordRestChannelAPI channelAPI,
        UserManagerService userManager,
        GameDataService gameData,
        GameLogicService gameLogic)
    {
        _logger = logger;
        _channelAPI = channelAPI;
        _userManager = userManager;
        _gameData = gameData;
        _gameLogic = gameLogic;
    }

    public async Task<Result> RespondAsync(IMessageCreate gatewayEvent, CancellationToken ct = default)
    {
        var message = gatewayEvent;
        
        // Ignore bot messages
        if (message.Author.IsBot.HasValue && message.Author.IsBot.Value)
            return Result.FromSuccess();

        var content = message.Content.Trim();
        
        // Check for commands
        if (content.StartsWith("!") || content.StartsWith("/"))
        {
            var parts = content.Substring(1).ToLower().Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length > 0)
            {
                await HandleCommand(message, parts[0], parts.Skip(1).ToArray(), ct);
            }
        }

        return Result.FromSuccess();
    }

    private async Task HandleCommand(IMessageCreate message, string command, string[] args, CancellationToken ct)
    {
        try
        {
            _logger.LogInformation("Handling command: {Command} from user {UserId}", command, message.Author.ID);

            var response = command switch
            {
                "start" or "play" => await HandleStartCommand(message.Author.ID.Value),
                "fish" => await HandleFishCommand(message.Author.ID.Value),
                "inventory" or "inv" => await HandleInventoryCommand(message.Author.ID.Value),
                "shop" => await HandleShopCommand(message.Author.ID.Value),
                "move" => await HandleMoveCommand(message.Author.ID.Value),
                "moveto" => await HandleMoveToCommand(message.Author.ID.Value, args),
                "sell" => await HandleSellCommand(message.Author.ID.Value, args),
                "buy" => await HandleBuyCommand(message.Author.ID.Value, args),
                "dig" => await HandleDigCommand(message.Author.ID.Value),
                "traps" => await HandleTrapsCommand(message.Author.ID.Value, args),
                "aquarium" => await HandleAquariumCommand(message.Author.ID.Value, args),
                "areas" => await HandleAreasCommand(),
                "help" => await HandleHelpCommand(),
                _ => "Unknown command. Type `!help` for a list of available commands."
            };

            // Create embed response
            var embed = new Embed(
                Description: response,
                Colour: Color.CornflowerBlue
            );

            await _channelAPI.CreateMessageAsync(
                message.ChannelID,
                embeds: new[] { embed },
                ct: ct
            );
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error handling command: {Command}", command);
            
            await _channelAPI.CreateMessageAsync(
                message.ChannelID,
                "Sorry, there was an error processing your command. Please try again.",
                ct: ct
            );
        }
    }

    private async Task<string> HandleStartCommand(ulong userId)
    {
        var userProfile = await _userManager.GetOrCreateUserAsync(userId.ToString());
        var isNewUser = userProfile.CreatedAt > DateTime.UtcNow.AddMinutes(-5);

        if (isNewUser)
        {
            return "üé£ **Welcome to the Fishing Adventure!**\n\n" +
                   "You've started your fishing journey! You begin at the Lake with basic equipment.\n\n" +
                   $"**Your Stats:**\n" +
                   $"üìç Area: {userProfile.Area}\n" +
                   $"‚≠ê Level: {userProfile.Level}\n" +
                   $"ü™ô Gold: {userProfile.Gold}\n" +
                   $"üé£ Rod: {userProfile.EquippedRod}\n" +
                   $"ü™± Bait: {userProfile.EquippedBait}\n\n" +
                   "**Available Commands:**\n" +
                   "`!fish` - Start fishing\n" +
                   "`!inventory` - View your items\n" +
                   "`!shop` - Visit the shop\n" +
                   "`!move` - Change areas\n" +
                   "`!help` - Show all commands";
        }
        else
        {
            return "üé£ **Welcome back to your fishing adventure!**\n\n" +
                   $"**Your Stats:**\n" +
                   $"üìç Area: {userProfile.Area}\n" +
                   $"‚≠ê Level: {userProfile.Level} (XP: {userProfile.Experience})\n" +
                   $"ü™ô Gold: {userProfile.Gold}\n" +
                   $"üé£ Rod: {userProfile.EquippedRod}\n" +
                   $"ü™± Bait: {userProfile.EquippedBait}\n\n" +
                   "Type `!fish` to start fishing or `!help` for all commands.";
        }
    }

    private async Task<string> HandleFishCommand(ulong userId)
    {
        var userProfile = await _userManager.GetOrCreateUserAsync(userId.ToString());
        
        // Check if user has equipped bait
        if (string.IsNullOrEmpty(userProfile.EquippedBait))
        {
            return "‚ùå You need to equip some bait first! You start with basic Worms.";
        }

        // Check if user has bait in inventory and auto-switch if needed
        if (string.IsNullOrEmpty(userProfile.EquippedBait) || 
            !userProfile.Inventory.ContainsKey(userProfile.EquippedBait) || 
            userProfile.Inventory[userProfile.EquippedBait] <= 0)
        {
            // Try to auto-switch to available bait
            var availableBait = userProfile.Inventory.Where(i => 
                _gameData.GetBaitByName(i.Key) != null && i.Value > 0)
                .FirstOrDefault();
            
            if (availableBait.Key != null)
            {
                userProfile.EquippedBait = availableBait.Key;
                await _userManager.UpdateUserAsync(userId.ToString(), userProfile);
                // Continue with fishing using the new bait
            }
            else
            {
                return $"‚ùå You don't have any bait left! \n\n" +
                       "üí° **Options:**\n" +
                       "‚Ä¢ Use `!dig` to search for free worms\n" +
                       "‚Ä¢ Use `!buy worms` to purchase bait\n" +
                       "‚Ä¢ Visit `!shop` to see all available bait";
            }
        }

        // Get current area
        var currentArea = _gameData.GetArea(userProfile.Area);
        if (currentArea == null)
        {
            return "‚ùå Invalid area. Use `!move` to select a valid fishing area.";
        }

        // Simple fishing logic - consume bait and attempt to catch a fish
        userProfile.Inventory[userProfile.EquippedBait]--;
        
        // Get a random fish from the current area
        var random = new Random();
        var availableFish = currentArea.Fish;
        var selectedFishName = availableFish[random.Next(availableFish.Count)];
        var fishData = _gameData.GetFishByName(selectedFishName);
        
        if (fishData == null)
        {
            return "‚ùå Something went wrong with fishing. Please try again.";
        }

        // Calculate success chance based on rod and area difficulty
        var rod = _gameData.GetRodByName(userProfile.EquippedRod);
        var baseSuccess = rod?.SuccessRate ?? 0.5;
        var difficultyPenalty = (currentArea.Difficulty - 1) * 0.1;
        var finalChance = Math.Max(0.1, baseSuccess - difficultyPenalty);
        
        // Check if fish requires special ability
        var requiresSpecialAbility = !string.IsNullOrEmpty(fishData.SpecialEffect);
        var hasCorrectAbility = rod != null && !string.IsNullOrEmpty(rod.SpecialAbility) && 
                               rod.SpecialAbility.Equals(fishData.SpecialEffect, StringComparison.OrdinalIgnoreCase);
        
        if (requiresSpecialAbility && !hasCorrectAbility)
        {
            // Fish that requires special ability but player doesn't have the right rod
            await _userManager.UpdateUserAsync(userId.ToString(), userProfile);
            
            return $"üé£ **Fish Spotted!** A {selectedFishName} is on your line!\n\n" +
                   $"‚ùå **Special Ability Required!** This fish needs a rod with **{fishData.SpecialEffect}** ability to catch.\n\n" +
                   $"üõçÔ∏è Visit the shop to get the right equipment:\n" +
                   $"‚Ä¢ Ice Rod (freeze ability)\n" +
                   $"‚Ä¢ Lightning Rod (shock ability)\n" +
                   $"‚Ä¢ Mystic Rod (charm ability)\n\n" +
                   $"ü™± {userProfile.EquippedBait} remaining: {userProfile.Inventory[userProfile.EquippedBait]}";
        }
        
        bool success;
        string specialStageMessage = "";
        
        if (requiresSpecialAbility && hasCorrectAbility)
        {
            // Multi-stage fishing for special fish
            specialStageMessage = $"‚ö° **Using {rod.SpecialAbility} ability!** ";
            switch (fishData.SpecialEffect?.ToLower())
            {
                case "freeze":
                    specialStageMessage += "The fish is frozen solid, making it easier to catch!";
                    break;
                case "shock":
                    specialStageMessage += "Electric shock stuns the fish!";
                    break;
                case "charm":
                    specialStageMessage += "Mystical charm calms the fish!";
                    break;
            }
            specialStageMessage += "\n\n";
            
            // Higher success rate with correct ability
            finalChance = Math.Min(0.9, finalChance + 0.3);
        }
        
        success = random.NextDouble() < finalChance;
        
        if (success)
        {
            // Add fish to inventory
            if (!userProfile.Fish.ContainsKey(selectedFishName))
                userProfile.Fish[selectedFishName] = 0;
            userProfile.Fish[selectedFishName]++;
            
            // Award experience
            var expGain = fishData.BaseValue;
            userProfile.Experience += expGain;
            
            // Check for level up
            var newLevel = CalculateLevel(userProfile.Experience);
            var leveledUp = newLevel > userProfile.Level;
            userProfile.Level = newLevel;
            
            // Save profile
            await _userManager.UpdateUserAsync(userId.ToString(), userProfile);
            
            var result = $"üé£ **Success!** You caught a {selectedFishName}!\n\n" +
                        specialStageMessage +
                        $"üìä **Fish Stats:**\n" +
                        $"üèÜ Rarity: {fishData.Rarity}\n" +
                        $"‚öñÔ∏è Weight: {fishData.Weight}kg\n" +
                        $"üí∞ Value: {fishData.BaseValue} gold\n";
            
            if (!string.IsNullOrEmpty(fishData.SpecialEffect))
            {
                result += $"‚ö° Special: {fishData.SpecialEffect}\n";
            }
            
            result += $"‚ú® XP Gained: +{expGain}\n\n" +
                     $"üìà **Your Progress:**\n" +
                     $"‚≠ê Level: {userProfile.Level} (XP: {userProfile.Experience})\n" +
                     $"ü™± {userProfile.EquippedBait} remaining: {userProfile.Inventory[userProfile.EquippedBait]}";
            
            if (leveledUp)
            {
                result += $"\n\nüéâ **LEVEL UP!** You are now level {userProfile.Level}!";
            }
            
            return result;
        }
        else
        {
            await _userManager.UpdateUserAsync(userId.ToString(), userProfile);
            
            return $"üé£ **The fish got away!**\n\n" +
                   $"Better luck next time. You still used your bait.\n" +
                   $"ü™± {userProfile.EquippedBait} remaining: {userProfile.Inventory[userProfile.EquippedBait]}\n\n" +
                   "üí° Try upgrading your rod at the shop for better success rates!";
        }
    }

    private async Task<string> HandleInventoryCommand(ulong userId)
    {
        var userProfile = await _userManager.GetOrCreateUserAsync(userId.ToString());

        var result = $"üéí **Your Inventory**\n\n" +
                    $"üí∞ **Gold:** {userProfile.Gold} ü™ô\n" +
                    $"‚≠ê **Level:** {userProfile.Level} (XP: {userProfile.Experience})\n\n";

        // Equipment
        result += "üõ†Ô∏è **Equipment:**\n";
        if (userProfile.Inventory.Any())
        {
            foreach (var item in userProfile.Inventory.OrderBy(x => x.Key))
            {
                result += $"  {item.Key}: {item.Value}\n";
            }
        }
        else
        {
            result += "  No items\n";
        }

        result += "\nüêü **Fish Collection:**\n";
        if (userProfile.Fish.Any())
        {
            foreach (var fish in userProfile.Fish.OrderBy(x => x.Key))
            {
                result += $"  {fish.Key}: {fish.Value}\n";
            }
        }
        else
        {
            result += "  No fish caught yet\n";
        }

        result += $"\n‚öôÔ∏è **Currently Equipped:**\n" +
                 $"üé£ Rod: {userProfile.EquippedRod}\n" +
                 $"ü™± Bait: {userProfile.EquippedBait}";

        return result;
    }

    private async Task<string> HandleShopCommand(ulong userId)
    {
        var userProfile = await _userManager.GetOrCreateUserAsync(userId.ToString());

        return $"üè™ **Fishing Shop**\n\n" +
               $"üí∞ You have: {userProfile.Gold} ü™ô\n\n" +
               "üé£ **Fishing Rods:**\n" +
               "‚Ä¢ Steel Rod: 150 ü™ô (Level 2+, 60% success)\n" +
               "‚Ä¢ Pro Rod: 300 ü™ô (Level 3+, 70% success)\n" +
               "‚Ä¢ Ice Rod: 450 ü™ô (Level 4+, 70% + freeze ability)\n" +
               "‚Ä¢ Lightning Rod: 600 ü™ô (Level 5+, 80% + shock ability)\n" +
               "‚Ä¢ Mystic Rod: 750 ü™ô (Level 6+, 80% + charm ability)\n\n" +
               "ü™± **Bait:**\n" +
               "‚Ä¢ Worms: 2 ü™ô for 10 (Basic bait)\n" +
               "‚Ä¢ Minnows: 4 ü™ô each (Better success rate)\n" +
               "‚Ä¢ Insects: 6 ü™ô each (High success rate)\n" +
               "‚Ä¢ Trap Bait: 1 ü™ô for 50 (For fish traps only)\n\n" +
               "ü™§ **Fish Traps:**\n" +
               "‚Ä¢ Basic Trap: 50 ü™ô (20 bait capacity, 5%/hour)\n" +
               "‚Ä¢ Steel Trap: 150 ü™ô (50 bait capacity, 8%/hour)\n" +
               "‚Ä¢ Pro Trap: 300 ü™ô (100 bait capacity, 12%/hour)\n\n" +
               "üê† **Aquariums:**\n" +
               "‚Ä¢ Basic Aquarium: 200 ü™ô (10 fish capacity)\n" +
               "‚Ä¢ Large Aquarium: 500 ü™ô (25 fish capacity)\n" +
               "‚Ä¢ Deluxe Aquarium: 1000 ü™ô (50 fish capacity)\n\n" +
               "üõçÔ∏è **Buy Items:**\n" +
               "Use `!buy <item_name>` to purchase items!\n\n" +
               "üí∞ **Sell Fish:**\n" +
               "Use `!sell <fish_name>` or `!sell all` to sell your fish!";
    }

    private async Task<string> HandleMoveCommand(ulong userId)
    {
        var areas = _gameData.GetAreas();
        var userProfile = await _userManager.GetOrCreateUserAsync(userId.ToString());

        var result = $"üö∂ **Available Fishing Areas**\n\n" +
                    $"üìç Current: {userProfile.Area}\n\n";

        foreach (var area in areas)
        {
            var status = area.Name == userProfile.Area ? "üìç (Current)" : "üåä";
            result += $"{status} **{area.Name}** (Level {area.Level})\n" +
                     $"  üêü Fish: {string.Join(", ", area.Fish.Take(3))}{(area.Fish.Count > 3 ? "..." : "")}\n" +
                     $"  üìñ {area.Description.Substring(0, Math.Min(60, area.Description.Length))}...\n\n";
        }

        result += "Use `!moveto <area_name>` to travel to a different area!";
        return result;
    }

    private async Task<string> HandleMoveToCommand(ulong userId, string[] args)
    {
        if (args.Length == 0)
        {
            return "‚ùå Please specify an area to move to. Example: `!moveto lake`";
        }

        var targetAreaName = string.Join(" ", args);
        var userProfile = await _userManager.GetOrCreateUserAsync(userId.ToString());
        var targetArea = _gameData.GetAreaByName(targetAreaName);

        if (targetArea == null)
        {
            return $"‚ùå Area '{targetAreaName}' not found. Use `!move` to see available areas.";
        }

        if (targetArea.Name.Equals(userProfile.Area, StringComparison.OrdinalIgnoreCase))
        {
            return $"üìç You are already in {targetArea.Name}!";
        }

        // Check level requirement
        if (userProfile.Level < targetArea.Level)
        {
            return $"‚ùå You need to be level {targetArea.Level} to access {targetArea.Name}. You are level {userProfile.Level}.";
        }

        // Update user's location
        userProfile.Area = targetArea.Name;
        await _userManager.UpdateUserAsync(userId.ToString(), userProfile);

        return $"üö∂ You traveled to **{targetArea.Name}**!\n\n" +
               $"üìñ {targetArea.Description}\n\n" +
               $"üêü Available Fish: {string.Join(", ", targetArea.Fish)}\n" +
               $"‚≠ê Difficulty: {targetArea.Difficulty}/4\n\n" +
               "Ready to start fishing? Use `!fish` to cast your line!";
    }

    private async Task<string> HandleSellCommand(ulong userId, string[] args)
    {
        if (args.Length == 0)
        {
            return "‚ùå Please specify which fish to sell. Example: `!sell carp` or `!sell all`";
        }

        var userProfile = await _userManager.GetOrCreateUserAsync(userId.ToString());
        var fishToSell = string.Join(" ", args).ToLower();

        if (fishToSell == "all")
        {
            if (!userProfile.Fish.Any())
            {
                return "‚ùå You don't have any fish to sell!";
            }

            int totalGold = 0;
            var salesReport = "üí∞ **Sold all fish:**\n";

            foreach (var fishEntry in userProfile.Fish.ToList())
            {
                var fishData = _gameData.GetFishByName(fishEntry.Key);
                if (fishData != null)
                {
                    var value = fishData.BaseValue * fishEntry.Value;
                    totalGold += value;
                    salesReport += $"  {fishEntry.Key} x{fishEntry.Value}: {value} gold\n";
                }
            }

            userProfile.Fish.Clear();
            userProfile.Gold += totalGold;
            await _userManager.UpdateUserAsync(userId.ToString(), userProfile);

            return salesReport + $"\nüí∞ **Total earned:** {totalGold} gold\n" +
                   $"ü™ô **New balance:** {userProfile.Gold} gold";
        }
        else
        {
            // Find the fish in user's collection
            var fishKey = userProfile.Fish.Keys.FirstOrDefault(f => 
                f.Equals(fishToSell, StringComparison.OrdinalIgnoreCase));

            if (fishKey == null || userProfile.Fish[fishKey] <= 0)
            {
                return $"‚ùå You don't have any {fishToSell} to sell!";
            }

            var fishData = _gameData.GetFishByName(fishKey);
            if (fishData == null)
            {
                return "‚ùå Error finding fish data. Please try again.";
            }

            userProfile.Fish[fishKey]--;
            if (userProfile.Fish[fishKey] <= 0)
            {
                userProfile.Fish.Remove(fishKey);
            }

            userProfile.Gold += fishData.BaseValue;
            await _userManager.UpdateUserAsync(userId.ToString(), userProfile);

            return $"üí∞ Sold 1x {fishKey} for {fishData.BaseValue} gold!\n" +
                   $"ü™ô New balance: {userProfile.Gold} gold";
        }
    }

    private async Task<string> HandleBuyCommand(ulong userId, string[] args)
    {
        if (args.Length == 0)
        {
            return "‚ùå Please specify what to buy. Example: `!buy worms` or `!buy steel rod`";
        }

        var userProfile = await _userManager.GetOrCreateUserAsync(userId.ToString());
        var itemToBuy = string.Join(" ", args).ToLower();

        // Handle different purchasable items
        switch (itemToBuy)
        {
            case "worms" or "worm":
                return await BuyBait(userProfile, userId, "Worms", 2, 10);
                
            case "minnows" or "minnow":
                return await BuyBait(userProfile, userId, "Minnows", 4, 1);
                
            case "insects" or "insect":
                return await BuyBait(userProfile, userId, "Insects", 6, 1);
                
            case "trap bait":
                return await BuyBait(userProfile, userId, "Trap Bait", 1, 50);

            case "steel rod":
                return await BuyRod(userProfile, userId, "Steel Rod", 150, 2);

            case "pro rod":
                return await BuyRod(userProfile, userId, "Pro Rod", 300, 3);

            case "ice rod":
                return await BuyRod(userProfile, userId, "Ice Rod", 450, 4);

            case "lightning rod":
                return await BuyRod(userProfile, userId, "Lightning Rod", 600, 5);

            case "mystic rod":
                return await BuyRod(userProfile, userId, "Mystic Rod", 750, 6);
                
            case "basic trap":
                return await BuyTrap(userProfile, userId, "Basic Trap", 50);
                
            case "steel trap":
                return await BuyTrap(userProfile, userId, "Steel Trap", 150);
                
            case "pro trap":
                return await BuyTrap(userProfile, userId, "Pro Trap", 300);
                
            case "basic aquarium":
                return await BuyAquarium(userProfile, userId, "Basic Aquarium", 200, 10);
                
            case "large aquarium":
                return await BuyAquarium(userProfile, userId, "Large Aquarium", 500, 25);
                
            case "deluxe aquarium":
                return await BuyAquarium(userProfile, userId, "Deluxe Aquarium", 1000, 50);

            default:
                return $"‚ùå '{itemToBuy}' is not available for purchase. Check `!shop` for available items.";
        }
    }

    private async Task<string> BuyBait(UserProfile userProfile, ulong userId, string baitName, int price, int quantity)
    {
        if (userProfile.Gold < price)
        {
            return $"‚ùå You need {price} gold to buy {quantity}x {baitName}. You have {userProfile.Gold} gold.";
        }

        userProfile.Gold -= price;
        
        if (!userProfile.Inventory.ContainsKey(baitName))
            userProfile.Inventory[baitName] = 0;
        
        userProfile.Inventory[baitName] += quantity;
        await _userManager.UpdateUserAsync(userId.ToString(), userProfile);

        return $"‚úÖ Purchased {quantity}x {baitName} for {price} gold!\n" +
               $"ü™ô Remaining gold: {userProfile.Gold}\n" +
               $"üéí You now have {userProfile.Inventory[baitName]} {baitName}";
    }

    private async Task<string> BuyRod(UserProfile userProfile, ulong userId, string rodName, int price, int requiredLevel)
    {
        if (userProfile.Level < requiredLevel)
        {
            return $"‚ùå You need to be level {requiredLevel} to buy {rodName}. You are level {userProfile.Level}.";
        }

        if (userProfile.Gold < price)
        {
            return $"‚ùå You need {price} gold to buy {rodName}. You have {userProfile.Gold} gold.";
        }

        if (userProfile.Equipment.ContainsKey(rodName))
        {
            return $"‚ùå You already own {rodName}!";
        }

        userProfile.Gold -= price;
        userProfile.Equipment[rodName] = 1;
        userProfile.EquippedRod = rodName; // Auto-equip new rod
        await _userManager.UpdateUserAsync(userId.ToString(), userProfile);

        var rodData = _gameData.GetRodByName(rodName);
        var abilityText = !string.IsNullOrEmpty(rodData?.SpecialAbility) 
            ? $"\n‚ö° Special Ability: {rodData.SpecialAbility}" 
            : "";

        return $"‚úÖ Purchased and equipped {rodName} for {price} gold!\n" +
               $"ü™ô Remaining gold: {userProfile.Gold}\n" +
               $"üé£ Success rate: {(rodData?.SuccessRate ?? 0.5) * 100:F0}%{abilityText}";
    }

    private async Task<string> BuyTrap(UserProfile userProfile, ulong userId, string trapName, int price)
    {
        if (userProfile.Gold < price)
        {
            return $"‚ùå You need {price} gold to buy {trapName}. You have {userProfile.Gold} gold.";
        }

        userProfile.Gold -= price;
        
        if (!userProfile.Traps.ContainsKey(trapName))
            userProfile.Traps[trapName] = 0;
        
        userProfile.Traps[trapName]++;
        await _userManager.UpdateUserAsync(userId.ToString(), userProfile);

        var trapDetails = trapName switch
        {
            "Basic Trap" => "20 bait capacity, 5% catch rate/hour",
            "Steel Trap" => "50 bait capacity, 8% catch rate/hour", 
            "Pro Trap" => "100 bait capacity, 12% catch rate/hour",
            _ => "Unknown specifications"
        };

        return $"‚úÖ Purchased {trapName} for {price} gold!\n" +
               $"ü™ô Remaining gold: {userProfile.Gold}\n" +
               $"ü™§ Trap specs: {trapDetails}\n" +
               $"üì¶ You now own {userProfile.Traps[trapName]} {trapName}(s)\n\n" +
               $"üí° Use `!traps place {trapName.ToLower()}` to deploy it!";
    }

    private async Task<string> BuyAquarium(UserProfile userProfile, ulong userId, string aquariumName, int price, int capacity)
    {
        if (userProfile.Gold < price)
        {
            return $"‚ùå You need {price} gold to buy {aquariumName}. You have {userProfile.Gold} gold.";
        }

        if (userProfile.Aquariums.Any())
        {
            return $"‚ùå You can only have one aquarium at a time. Upgrade your current one instead!";
        }

        userProfile.Gold -= price;
        
        var newAquarium = new Aquarium
        {
            Name = aquariumName,
            WaterQuality = 100,
            Temperature = 75,
            LastCleaned = DateTime.UtcNow,
            LastMaintenance = DateTime.UtcNow
        };
        
        userProfile.Aquariums.Add(newAquarium);
        await _userManager.UpdateUserAsync(userId.ToString(), userProfile);

        return $"‚úÖ Purchased {aquariumName} for {price} gold!\n" +
               $"ü™ô Remaining gold: {userProfile.Gold}\n" +
               $"üê† Capacity: {capacity} fish\n" +
               $"üíß Water quality: 100% (pristine)\n" +
               $"üå°Ô∏è Temperature: 75% (optimal)\n\n" +
               $"üí° Use `!aquarium add <fish_name>` to add fish from your collection!";
    }

    private async Task<string> HandleDigCommand(ulong userId)
    {
        var userProfile = await _userManager.GetOrCreateUserAsync(userId.ToString());
        
        // Check cooldown (10 minutes between digs)
        if (userProfile.LastActive != DateTime.MinValue)
        {
            var timeSinceLastDig = DateTime.UtcNow - userProfile.LastActive;
            if (timeSinceLastDig.TotalMinutes < 10)
            {
                var remaining = TimeSpan.FromMinutes(10) - timeSinceLastDig;
                return $"‚è∞ You need to wait {remaining.Minutes}m {remaining.Seconds}s before digging again.";
            }
        }
        
        userProfile.LastActive = DateTime.UtcNow;
        
        // Random chance to find worms (70% success rate)
        var random = new Random();
        var success = random.NextDouble() < 0.7;
        
        if (success)
        {
            var wormsFound = random.Next(3, 8); // 3-7 worms
            
            if (!userProfile.Inventory.ContainsKey("Worms"))
                userProfile.Inventory["Worms"] = 0;
            
            userProfile.Inventory["Worms"] += wormsFound;
            
            // Auto-equip worms if no bait equipped
            if (string.IsNullOrEmpty(userProfile.EquippedBait))
            {
                userProfile.EquippedBait = "Worms";
            }
            
            await _userManager.UpdateUserAsync(userId.ToString(), userProfile);
            
            return $"üêõ **Success!** You found {wormsFound} worms while digging!\n\n" +
                   $"üéí You now have {userProfile.Inventory["Worms"]} worms total\n" +
                   $"‚è∞ You can dig again in 10 minutes\n\n" +
                   "üí° Digging is a free way to get basic bait when you're low on gold!";
        }
        else
        {
            await _userManager.UpdateUserAsync(userId.ToString(), userProfile);
            
            return $"üï≥Ô∏è **No luck!** You dug around but didn't find any worms.\n\n" +
                   $"‚è∞ You can try again in 10 minutes\n\n" +
                   "üí° Tip: Digging has a 70% success rate for finding 3-7 worms.";
        }
    }

    private async Task<string> HandleTrapsCommand(ulong userId, string[] args)
    {
        var userProfile = await _userManager.GetOrCreateUserAsync(userId.ToString());
        
        if (args.Length == 0)
        {
            return $"ü™§ **Fish Traps System**\n\n" +
                   $"üìç Current Area: {userProfile.Area}\n" +
                   $"ü™§ Owned Traps: {userProfile.Traps.Sum(t => t.Value)}\n\n" +
                   "**Trap Commands:**\n" +
                   "‚Ä¢ `!traps place <trap_name>` - Place a trap in current area\n" +
                   "‚Ä¢ `!traps check` - Check all your active traps\n" +
                   "‚Ä¢ `!traps collect` - Collect fish from ready traps\n" +
                   "‚Ä¢ `!traps status` - Show trap statistics\n\n" +
                   "**Available Traps:**\n" +
                   "‚Ä¢ Basic Trap: 50 ü™ô (holds 20 bait, 5% catch rate/hour)\n" +
                   "‚Ä¢ Steel Trap: 150 ü™ô (holds 50 bait, 8% catch rate/hour)\n" +
                   "‚Ä¢ Pro Trap: 300 ü™ô (holds 100 bait, 12% catch rate/hour)\n\n" +
                   "üí° Traps are a passive way to catch fish while you're away!";
        }

        var subCommand = args[0].ToLower();
        
        return subCommand switch
        {
            "place" => await HandleTrapPlace(userProfile, userId, args.Skip(1).ToArray()),
            "check" => await HandleTrapCheck(userProfile, userId),
            "collect" => await HandleTrapCollect(userProfile, userId),
            "status" => await HandleTrapStatus(userProfile, userId),
            _ => "‚ùå Unknown trap command. Use `!traps` to see available commands."
        };
    }

    private async Task<string> HandleTrapPlace(UserProfile userProfile, ulong userId, string[] args)
    {
        if (args.Length == 0)
        {
            return "‚ùå Please specify which trap to place. Example: `!traps place basic trap`";
        }

        var trapName = string.Join(" ", args).ToLower() switch
        {
            "basic" or "basic trap" => "Basic Trap",
            "steel" or "steel trap" => "Steel Trap", 
            "pro" or "pro trap" => "Pro Trap",
            _ => null
        };

        if (trapName == null)
        {
            return "‚ùå Invalid trap name. Available: basic trap, steel trap, pro trap";
        }

        // Check if user owns this trap
        if (!userProfile.Traps.ContainsKey(trapName) || userProfile.Traps[trapName] <= 0)
        {
            return $"‚ùå You don't own any {trapName}. Visit the shop to buy one!";
        }

        // Check if user has trap bait
        if (!userProfile.Inventory.ContainsKey("Trap Bait") || userProfile.Inventory["Trap Bait"] <= 0)
        {
            return "‚ùå You need Trap Bait to use fish traps. Buy some from the shop!";
        }

        // Initialize placed traps if not exists
        if (!userProfile.Equipment.ContainsKey("PlacedTraps"))
        {
            userProfile.Equipment["PlacedTraps"] = 0;
        }

        // Place the trap
        userProfile.Traps[trapName]--;
        userProfile.Equipment["PlacedTraps"]++;

        // Calculate bait capacity and use it
        var baitCapacity = trapName switch
        {
            "Basic Trap" => 20,
            "Steel Trap" => 50,
            "Pro Trap" => 100,
            _ => 20
        };

        var baitToUse = Math.Min(baitCapacity, userProfile.Inventory["Trap Bait"]);
        userProfile.Inventory["Trap Bait"] -= baitToUse;

        // Store trap placement data 
        var trapKey = $"trap_{userProfile.Area}_{DateTime.UtcNow.Ticks}";
        userProfile.Equipment[trapKey] = baitToUse; // Store bait amount
        userProfile.Equipment[$"{trapKey}_type"] = trapName switch
        {
            "Basic Trap" => 1,
            "Steel Trap" => 2,
            "Pro Trap" => 3,
            _ => 1
        };
        userProfile.Equipment[$"{trapKey}_placed"] = (int)DateTimeOffset.UtcNow.ToUnixTimeSeconds();

        await _userManager.UpdateUserAsync(userId.ToString(), userProfile);

        return $"‚úÖ **{trapName} placed successfully!**\n\n" +
               $"üìç Location: {userProfile.Area}\n" +
               $"ü™± Bait loaded: {baitToUse}\n" +
               $"‚è∞ Placed at: {DateTime.UtcNow:HH:mm UTC}\n\n" +
               $"üé£ The trap will passively catch fish over time!\n" +
               $"Use `!traps check` to monitor progress.";
    }

    private async Task<string> HandleTrapCheck(UserProfile userProfile, ulong userId)
    {
        var placedTraps = userProfile.Equipment
            .Where(kv => kv.Key.StartsWith("trap_") && !kv.Key.Contains("_type") && !kv.Key.Contains("_placed"))
            .ToList();

        if (!placedTraps.Any())
        {
            return "ü™§ You don't have any active traps placed.\n\n" +
                   "üí° Use `!traps place <trap_name>` to deploy a trap!";
        }

        var result = "ü™§ **Active Traps Status:**\n\n";
        
        foreach (var trap in placedTraps)
        {
            var trapKey = trap.Key;
            var baitRemaining = trap.Value;
            var trapTypeKey = $"{trapKey}_type";
            var trapPlacedKey = $"{trapKey}_placed";

            if (!userProfile.Equipment.ContainsKey(trapTypeKey) || !userProfile.Equipment.ContainsKey(trapPlacedKey))
                continue;

            var trapType = userProfile.Equipment[trapTypeKey] switch
            {
                1 => "Basic Trap",
                2 => "Steel Trap", 
                3 => "Pro Trap",
                _ => "Unknown Trap"
            };

            var placedTime = DateTimeOffset.FromUnixTimeSeconds(userProfile.Equipment[trapPlacedKey]).DateTime;
            var timeElapsed = DateTime.UtcNow - placedTime;
            var location = trapKey.Split('_')[1];

            // Calculate potential catches
            var catchRate = userProfile.Equipment[trapTypeKey] switch
            {
                1 => 0.05, // 5% per hour
                2 => 0.08, // 8% per hour  
                3 => 0.12, // 12% per hour
                _ => 0.05
            };

            var hoursElapsed = timeElapsed.TotalHours;
            var potentialCatches = (int)(hoursElapsed * catchRate * baitRemaining);

            result += $"üé£ **{trapType}** in {location}\n" +
                     $"   ‚è∞ Running for: {timeElapsed.Hours}h {timeElapsed.Minutes}m\n" +
                     $"   ü™± Bait: {baitRemaining}\n" +
                     $"   üêü Potential catches: ~{potentialCatches}\n\n";
        }

        result += "üí° Use `!traps collect` to gather fish from all traps!";
        return result;
    }

    private async Task<string> HandleTrapCollect(UserProfile userProfile, ulong userId)
    {
        var placedTraps = userProfile.Equipment
            .Where(kv => kv.Key.StartsWith("trap_") && !kv.Key.Contains("_type") && !kv.Key.Contains("_placed"))
            .ToList();

        if (!placedTraps.Any())
        {
            return "ü™§ You don't have any active traps to collect from.\n\n" +
                   "üí° Use `!traps place <trap_name>` to deploy a trap!";
        }

        var totalFishCaught = 0;
        var totalGoldEarned = 0;
        var collectionReport = "üé£ **Trap Collection Results:**\n\n";
        var random = new Random();
        var currentArea = _gameData.GetArea(userProfile.Area);

        foreach (var trap in placedTraps.ToList()) // ToList to avoid modification during iteration
        {
            var trapKey = trap.Key;
            var baitRemaining = trap.Value;
            var trapTypeKey = $"{trapKey}_type";
            var trapPlacedKey = $"{trapKey}_placed";

            if (!userProfile.Equipment.ContainsKey(trapTypeKey) || !userProfile.Equipment.ContainsKey(trapPlacedKey))
                continue;

            var trapType = userProfile.Equipment[trapTypeKey];
            var placedTime = DateTimeOffset.FromUnixTimeSeconds(userProfile.Equipment[trapPlacedKey]).DateTime;
            var timeElapsed = DateTime.UtcNow - placedTime;
            var location = trapKey.Split('_')[1];

            // Calculate actual catches
            var catchRate = trapType switch
            {
                1 => 0.05, // 5% per hour
                2 => 0.08, // 8% per hour
                3 => 0.12, // 12% per hour
                _ => 0.05
            };

            var hoursElapsed = timeElapsed.TotalHours;
            var baseCatches = hoursElapsed * catchRate;
            var actualCatches = 0;

            // Roll for each potential catch
            for (int i = 0; i < baitRemaining; i++)
            {
                if (random.NextDouble() < baseCatches / baitRemaining)
                {
                    actualCatches++;
                }
            }

            if (actualCatches > 0)
            {
                // Generate fish from trap location area
                var trapArea = _gameData.GetAreaByName(location) ?? currentArea;
                for (int i = 0; i < actualCatches; i++)
                {
                    var fishName = trapArea.Fish[random.Next(trapArea.Fish.Count)];
                    var fishData = _gameData.GetFishByName(fishName);
                    
                    if (fishData != null)
                    {
                        // Add to inventory
                        if (!userProfile.Fish.ContainsKey(fishName))
                            userProfile.Fish[fishName] = 0;
                        userProfile.Fish[fishName]++;
                        
                        // Calculate value (traps give slightly less value)
                        var value = (int)(fishData.BaseValue * 0.8); // 80% of normal value
                        totalGoldEarned += value;
                    }
                }
                totalFishCaught += actualCatches;
            }

            var trapTypeName = trapType switch
            {
                1 => "Basic Trap",
                2 => "Steel Trap",
                3 => "Pro Trap", 
                _ => "Unknown Trap"
            };

            collectionReport += $"ü™§ {trapTypeName} ({location}): {actualCatches} fish\n";

            // Remove the trap (it's been collected)
            userProfile.Equipment.Remove(trapKey);
            userProfile.Equipment.Remove(trapTypeKey);
            userProfile.Equipment.Remove(trapPlacedKey);
            userProfile.Equipment["PlacedTraps"]--;
        }

        userProfile.Gold += totalGoldEarned;
        await _userManager.UpdateUserAsync(userId.ToString(), userProfile);

        collectionReport += $"\nüé£ **Total Results:**\n" +
                           $"üêü Fish caught: {totalFishCaught}\n" +
                           $"üí∞ Gold earned: {totalGoldEarned}\n" +
                           $"ü™ô New balance: {userProfile.Gold}\n\n" +
                           "‚úÖ All traps have been collected and need to be placed again.";

        return collectionReport;
    }

    private async Task<string> HandleTrapStatus(UserProfile userProfile, ulong userId)
    {
        var activeTrapCount = userProfile.Equipment.ContainsKey("PlacedTraps") ? 
            userProfile.Equipment["PlacedTraps"] : 0;

        return $"üìä **Trap Statistics:**\n\n" +
               $"ü™§ Active traps: {activeTrapCount}\n" +
               $"üì¶ Owned traps: {userProfile.Traps.Sum(t => t.Value)}\n" +
               $"ü™± Trap bait: {(userProfile.Inventory.ContainsKey("Trap Bait") ? userProfile.Inventory["Trap Bait"] : 0)}\n\n" +
               "**Trap Efficiency:**\n" +
               "‚Ä¢ Basic Trap: 5% catch rate per hour\n" +
               "‚Ä¢ Steel Trap: 8% catch rate per hour\n" +
               "‚Ä¢ Pro Trap: 12% catch rate per hour\n\n" +
               "üí° Traps give 80% of normal fish value but work passively!";
    }

    private async Task<string> HandleAquariumCommand(ulong userId, string[] args)
    {
        var userProfile = await _userManager.GetOrCreateUserAsync(userId.ToString());
        
        if (userProfile.Aquariums == null || !userProfile.Aquariums.Any())
        {
            return $"üê† **Aquarium System**\n\n" +
                   $"You don't have any aquariums yet!\n\n" +
                   "**Get Started:**\n" +
                   "‚Ä¢ `!buy basic aquarium` - Purchase your first aquarium (200 ü™ô)\n\n" +
                   "**Aquarium Features:**\n" +
                   "‚Ä¢ Store and display your favorite fish\n" +
                   "‚Ä¢ Fish can breed and grow if kept happy\n" +
                   "‚Ä¢ Requires regular maintenance (feeding, cleaning)\n" +
                   "‚Ä¢ Decorate with items to boost fish happiness\n" +
                   "‚Ä¢ Name your fish and watch them thrive!\n\n" +
                   "üí° Happy fish in aquariums can breed rare variants!";
        }
        
        // Process aquarium maintenance first
        await ProcessAquariumMaintenance(userProfile, userId);
        
        if (args.Length == 0)
        {
            // Show current aquarium status
            return await ShowAquariumStatus(userProfile);
        }

        var subCommand = args[0].ToLower();
        
        return subCommand switch
        {
            "feed" => await HandleAquariumFeed(userProfile, userId),
            "clean" => await HandleAquariumClean(userProfile, userId),
            "add" => await HandleAquariumAdd(userProfile, userId, args.Skip(1).ToArray()),
            "remove" => await HandleAquariumRemove(userProfile, userId, args.Skip(1).ToArray()),
            "view" or "list" => await HandleAquariumView(userProfile),
            "name" => await HandleAquariumName(userProfile, userId, args.Skip(1).ToArray()),
            "status" => await ShowAquariumStatus(userProfile),
            _ => "‚ùå Unknown aquarium command. Available: feed, clean, add, remove, view, name, status"
        };
    }

    private async Task ProcessAquariumMaintenance(UserProfile userProfile, ulong userId)
    {
        var aquarium = userProfile.Aquariums.FirstOrDefault();
        if (aquarium == null) return;

        var timeSinceLastMaintenance = DateTime.UtcNow - aquarium.LastMaintenance;
        var hoursSince = timeSinceLastMaintenance.TotalHours;

        if (hoursSince > 0)
        {
            // Degrade water quality over time (1% per hour)
            aquarium.WaterQuality = Math.Max(0, aquarium.WaterQuality - (int)(hoursSince * 1));
            
            // Fish get hungrier over time (2% per hour)
            foreach (var fish in aquarium.Fish)
            {
                fish.Hunger = Math.Min(100, fish.Hunger + (int)(hoursSince * 2));
                
                // Happiness decreases if hungry or poor water quality
                if (fish.Hunger > 70 || aquarium.WaterQuality < 50)
                {
                    fish.Happiness = Math.Max(0, fish.Happiness - (int)(hoursSince * 3));
                }
                else if (fish.Hunger < 30 && aquarium.WaterQuality > 80)
                {
                    fish.Happiness = Math.Min(100, fish.Happiness + (int)(hoursSince * 1));
                }
            }

            aquarium.LastMaintenance = DateTime.UtcNow;
            await _userManager.UpdateUserAsync(userId.ToString(), userProfile);
        }
    }

    private async Task<string> ShowAquariumStatus(UserProfile userProfile)
    {
        var aquarium = userProfile.Aquariums.FirstOrDefault();
        if (aquarium == null) return "‚ùå No aquarium found.";
        
        var fishCount = aquarium.Fish?.Count ?? 0;
        var capacity = aquarium.Name switch
        {
            "Basic Aquarium" => 10,
            "Large Aquarium" => 25, 
            "Deluxe Aquarium" => 50,
            _ => 10
        };

        var avgHappiness = CalculateAverageHappiness(aquarium);
        var avgHunger = aquarium.Fish.Any() ? (int)aquarium.Fish.Average(f => f.Hunger) : 0;

        var status = $"üê† **{aquarium.Name}**\n\n" +
                    $"üè† Fish: {fishCount}/{capacity}\n" +
                    $"üíß Water Quality: {GetStatusIcon(aquarium.WaterQuality)} {aquarium.WaterQuality}%\n" +
                    $"üòä Average Happiness: {GetStatusIcon(avgHappiness)} {avgHappiness}%\n" +
                    $"üçΩÔ∏è Average Hunger: {GetHungerIcon(avgHunger)} {avgHunger}%\n\n";

        if (fishCount > 0)
        {
            status += "üêü **Recent Fish:**\n";
            foreach (var fish in aquarium.Fish.Take(3))
            {
                var displayName = !string.IsNullOrEmpty(fish.CustomName) ? fish.CustomName : fish.Name;
                status += $"  ‚Ä¢ {displayName} - {GetStatusIcon(fish.Happiness)} {fish.Happiness}% happy\n";
            }
            if (fishCount > 3)
            {
                status += $"  ... and {fishCount - 3} more\n";
            }
            status += "\n";
        }

        status += "**Commands:**\n" +
                 "‚Ä¢ `!aquarium feed` - Feed all fish\n" +
                 "‚Ä¢ `!aquarium clean` - Clean the water\n" +
                 "‚Ä¢ `!aquarium add <fish_name>` - Add fish from inventory\n" +
                 "‚Ä¢ `!aquarium view` - View all fish details\n\n";

        // Maintenance alerts
        if (aquarium.WaterQuality < 50)
        {
            status += "‚ö†Ô∏è **Alert:** Water quality is poor! Use `!aquarium clean`\n";
        }
        if (avgHunger > 70)
        {
            status += "‚ö†Ô∏è **Alert:** Fish are hungry! Use `!aquarium feed`\n";
        }
        if (avgHappiness > 80 && fishCount >= 2)
        {
            status += "üíù **Breeding possible!** Happy fish may produce offspring!\n";
        }

        return status;
    }

    private string GetStatusIcon(int value)
    {
        return value switch
        {
            >= 80 => "üü¢",
            >= 60 => "üü°", 
            >= 40 => "üü†",
            _ => "üî¥"
        };
    }

    private string GetHungerIcon(int hunger)
    {
        return hunger switch
        {
            <= 30 => "üü¢", // Well fed
            <= 60 => "üü°", // Getting hungry
            <= 80 => "üü†", // Hungry
            _ => "üî¥" // Very hungry
        };
    }

    private async Task<string> HandleAquariumFeed(UserProfile userProfile, ulong userId)
    {
        var aquarium = userProfile.Aquariums.FirstOrDefault();
        if (aquarium == null) return "‚ùå No aquarium found.";
        
        if (!aquarium.Fish.Any())
        {
            return "üê† Your aquarium doesn't have any fish to feed!";
        }

        // Check if user has fish food (use worms as fish food)
        if (!userProfile.Inventory.ContainsKey("Worms") || userProfile.Inventory["Worms"] <= 0)
        {
            return "‚ùå You don't have any fish food! Use worms to feed your fish.\n\n" +
                   "üí° Buy worms from the shop or use `!dig` to find free ones.";
        }

        // Feed fish (costs 1 worm per 2 fish)
        var foodNeeded = Math.Max(1, aquarium.Fish.Count / 2);
        if (userProfile.Inventory["Worms"] < foodNeeded)
        {
            return $"‚ùå You need {foodNeeded} worms to feed all your fish. You have {userProfile.Inventory["Worms"]}.";
        }

        userProfile.Inventory["Worms"] -= foodNeeded;

        // Reset hunger and boost happiness
        foreach (var fish in aquarium.Fish)
        {
            fish.Hunger = 0;
            fish.Happiness = Math.Min(100, fish.Happiness + 10);
            fish.LastFed = DateTime.UtcNow;
        }

        aquarium.LastFed = DateTime.UtcNow;
        await _userManager.UpdateUserAsync(userId.ToString(), userProfile);

        return $"üçΩÔ∏è **Fed all fish!**\n\n" +
               $"ü™± Food used: {foodNeeded} worms\n" +
               $"üòä All fish happiness increased by 10%\n" +
               $"ü™± Worms remaining: {userProfile.Inventory["Worms"]}\n\n" +
               "üí° Well-fed fish are happier and more likely to breed!";
    }

    private async Task<string> HandleAquariumClean(UserProfile userProfile, ulong userId)
    {
        var aquarium = userProfile.Aquariums.FirstOrDefault();
        if (aquarium == null) return "‚ùå No aquarium found.";

        if (aquarium.WaterQuality >= 90)
        {
            return "üíß Your aquarium water is already very clean! (90%+)";
        }

        // Cleaning costs gold
        var cleaningCost = 5;
        if (userProfile.Gold < cleaningCost)
        {
            return $"‚ùå You need {cleaningCost} gold to clean the aquarium. You have {userProfile.Gold} gold.";
        }

        userProfile.Gold -= cleaningCost;
        aquarium.WaterQuality = 100;
        aquarium.LastCleaned = DateTime.UtcNow;

        // Happy fish from clean water
        foreach (var fish in aquarium.Fish)
        {
            fish.Happiness = Math.Min(100, fish.Happiness + 5);
        }

        await _userManager.UpdateUserAsync(userId.ToString(), userProfile);

        return $"üíß **Aquarium cleaned!**\n\n" +
               $"üí∞ Cost: {cleaningCost} gold\n" +
               $"üíß Water quality: 100% (pristine)\n" +
               $"üòä All fish happiness increased by 5%\n" +
               $"ü™ô Gold remaining: {userProfile.Gold}\n\n" +
               "‚ú® Your fish love the clean water!";
    }

    private async Task<string> HandleAquariumAdd(UserProfile userProfile, ulong userId, string[] args)
    {
        if (args.Length == 0)
        {
            return "‚ùå Please specify which fish to add. Example: `!aquarium add carp`";
        }

        var aquarium = userProfile.Aquariums.FirstOrDefault();
        if (aquarium == null) return "‚ùå No aquarium found.";

        var capacity = aquarium.Name switch
        {
            "Basic Aquarium" => 10,
            "Large Aquarium" => 25,
            "Deluxe Aquarium" => 50,
            _ => 10
        };

        if (aquarium.Fish.Count >= capacity)
        {
            return $"‚ùå Your aquarium is full! ({aquarium.Fish.Count}/{capacity})\n\n" +
                   "üí° Consider upgrading to a larger aquarium.";
        }

        var fishName = string.Join(" ", args);
        var fishKey = userProfile.Fish.Keys.FirstOrDefault(f => 
            f.Equals(fishName, StringComparison.OrdinalIgnoreCase));

        if (fishKey == null || userProfile.Fish[fishKey] <= 0)
        {
            return $"‚ùå You don't have any {fishName} to add!\n\n" +
                   "üí° Catch fish first using `!fish` command.";
        }

        // Remove from inventory and add to aquarium
        userProfile.Fish[fishKey]--;
        if (userProfile.Fish[fishKey] <= 0)
        {
            userProfile.Fish.Remove(fishKey);
        }

        var newAquariumFish = new AquariumFish
        {
            Name = fishKey,
            Happiness = 70, // Starting happiness
            Hunger = 20,    // Slightly hungry
            AddedAt = DateTime.UtcNow,
            Size = "Normal"
        };

        aquarium.Fish.Add(newAquariumFish);
        await _userManager.UpdateUserAsync(userId.ToString(), userProfile);

        return $"üê† **Added {fishKey} to aquarium!**\n\n" +
               $"üè† Aquarium space: {aquarium.Fish.Count}/{capacity}\n" +
               $"üòä Starting happiness: 70%\n" +
               $"üìÖ Added on: {DateTime.UtcNow:MM/dd HH:mm}\n\n" +
               "üí° Use `!aquarium name {fishKey}` to give it a custom name!";
    }

    private async Task<string> HandleAquariumView(UserProfile userProfile)
    {
        var aquarium = userProfile.Aquariums.FirstOrDefault();
        if (aquarium == null) return "‚ùå No aquarium found.";

        if (!aquarium.Fish.Any())
        {
            return "üê† Your aquarium is empty!\n\n" +
                   "üí° Use `!aquarium add <fish_name>` to add fish from your collection.";
        }

        var result = $"üê† **All Fish in {aquarium.Name}:**\n\n";
        
        for (int i = 0; i < aquarium.Fish.Count; i++)
        {
            var fish = aquarium.Fish[i];
            var displayName = !string.IsNullOrEmpty(fish.CustomName) ? 
                $"{fish.CustomName} ({fish.Name})" : fish.Name;
            
            var age = DateTime.UtcNow - fish.AddedAt;
            var ageText = age.TotalDays >= 1 ? $"{age.Days}d" : $"{age.Hours}h";
            
            result += $"{i + 1}. **{displayName}**\n" +
                     $"   üòä Happiness: {GetStatusIcon(fish.Happiness)} {fish.Happiness}%\n" +
                     $"   üçΩÔ∏è Hunger: {GetHungerIcon(fish.Hunger)} {fish.Hunger}%\n" +
                     $"   üìè Size: {fish.Size}\n" +
                     $"   üìÖ Age: {ageText}\n\n";
        }

        result += $"**Total: {aquarium.Fish.Count} fish**\n\n" +
                 "üí° Use `!aquarium name <number> <new_name>` to rename fish!";

        return result;
    }

    private async Task<string> HandleAquariumName(UserProfile userProfile, ulong userId, string[] args)
    {
        if (args.Length < 2)
        {
            return "‚ùå Usage: `!aquarium name <fish_number> <new_name>`\n\n" +
                   "Example: `!aquarium name 1 Goldie`\n" +
                   "Use `!aquarium view` to see fish numbers.";
        }

        var aquarium = userProfile.Aquariums.FirstOrDefault();
        if (aquarium == null) return "‚ùå No aquarium found.";

        if (!int.TryParse(args[0], out int fishIndex) || fishIndex < 1 || fishIndex > aquarium.Fish.Count)
        {
            return $"‚ùå Invalid fish number. Use a number between 1 and {aquarium.Fish.Count}.";
        }

        var newName = string.Join(" ", args.Skip(1));
        if (newName.Length > 20)
        {
            return "‚ùå Fish name must be 20 characters or less.";
        }

        var fish = aquarium.Fish[fishIndex - 1];
        var oldName = !string.IsNullOrEmpty(fish.CustomName) ? fish.CustomName : fish.Name;
        fish.CustomName = newName;

        await _userManager.UpdateUserAsync(userId.ToString(), userProfile);

        return $"‚úÖ **Fish renamed!**\n\n" +
               $"Old name: {oldName}\n" +
               $"New name: {newName}\n\n" +
               "üê† Your fish loves its new name!";
    }

    private async Task<string> HandleAquariumRemove(UserProfile userProfile, ulong userId, string[] args)
    {
        if (args.Length == 0)
        {
            return "‚ùå Usage: `!aquarium remove <fish_number>`\n\n" +
                   "Use `!aquarium view` to see fish numbers.";
        }

        var aquarium = userProfile.Aquariums.FirstOrDefault();
        if (aquarium == null) return "‚ùå No aquarium found.";

        if (!int.TryParse(args[0], out int fishIndex) || fishIndex < 1 || fishIndex > aquarium.Fish.Count)
        {
            return $"‚ùå Invalid fish number. Use a number between 1 and {aquarium.Fish.Count}.";
        }

        var fish = aquarium.Fish[fishIndex - 1];
        var displayName = !string.IsNullOrEmpty(fish.CustomName) ? 
            $"{fish.CustomName} ({fish.Name})" : fish.Name;
        
        // Return fish to inventory
        if (!userProfile.Fish.ContainsKey(fish.Name))
            userProfile.Fish[fish.Name] = 0;
        userProfile.Fish[fish.Name]++;

        aquarium.Fish.RemoveAt(fishIndex - 1);
        await _userManager.UpdateUserAsync(userId.ToString(), userProfile);

        return $"üê† **Removed {displayName} from aquarium!**\n\n" +
               $"The fish has been returned to your collection.\n" +
               $"üè† Aquarium space: {aquarium.Fish.Count}/{(aquarium.Name switch { "Basic Aquarium" => 10, "Large Aquarium" => 25, "Deluxe Aquarium" => 50, _ => 10 })}";
    }

    private int CalculateAverageHappiness(Aquarium aquarium)
    {
        if (aquarium.Fish == null || !aquarium.Fish.Any())
            return 100;
        
        var avgHappiness = aquarium.Fish.Average(f => f.Happiness);
        return (int)Math.Round(avgHappiness);
    }

    private async Task<string> HandleAreasCommand()
    {
        var areas = _gameData.GetAreas();
        var result = "üó∫Ô∏è **All Fishing Areas**\n\n";

        foreach (var area in areas)
        {
            result += $"üåä **{area.Name}** (Level {area.Level}, Difficulty {area.Difficulty})\n" +
                     $"üìñ {area.Description}\n" +
                     $"üêü Fish: {string.Join(", ", area.Fish)}\n\n";
        }

        return result;
    }

    private async Task<string> HandleHelpCommand()
    {
        return "üé£ **ZPT Fishing Bot Commands**\n\n" +
               "**Basic Commands:**\n" +
               "`!start` or `!play` - Start your fishing adventure\n" +
               "`!fish` - Cast your line and try to catch fish\n" +
               "`!inventory` or `!inv` - View your items and fish\n" +
               "`!shop` - Visit the fishing shop\n" +
               "`!move` - View available fishing areas\n" +
               "`!moveto <area>` - Travel to a specific area\n" +
               "`!areas` - See detailed area information\n\n" +
               "**Trading Commands:**\n" +
               "`!sell <fish>` - Sell a specific fish for gold\n" +
               "`!sell all` - Sell all your fish\n" +
               "`!buy <item>` - Purchase equipment from the shop\n\n" +
               "**Advanced Commands:**\n" +
               "`!dig` - Search for free worms (10min cooldown)\n" +
               "`!traps` - Manage your fish traps\n" +
               "`!aquarium` - View and manage your aquariums\n\n" +
               "`!help` - Show this help message\n\n" +
               "**Tips:**\n" +
               "‚Ä¢ Start at the Lake for easier fish\n" +
               "‚Ä¢ Upgrade your rod for better success rates\n" +
               "‚Ä¢ Different areas have different fish species\n" +
               "‚Ä¢ Sell fish for gold to buy better equipment\n" +
               "‚Ä¢ Higher level areas have rarer fish but are harder\n" +
               "‚Ä¢ Use `!dig` for free worms when you're broke\n" +
               "‚Ä¢ Fish traps provide passive income\n" +
               "‚Ä¢ Aquariums let fish breed and grow\n\n" +
               "Happy fishing! üé£";
    }

    private static int CalculateLevel(int experience)
    {
        // Simple level calculation: 100 XP per level
        return Math.Max(1, experience / 100 + 1);
    }
}